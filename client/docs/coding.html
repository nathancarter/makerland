<html>
    <head>
        <script src='https://code.jquery.com/jquery-1.11.2.min.js'></script>
        <script src='https://code.jquery.com/jquery-migrate-1.2.1.min.js'>
        </script>
        <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css'/>
        <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css'/>
        <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js'>
        </script>
        <link rel="stylesheet" href="../codemirror.css">
        <script src="../codemirror.js"></script>
        <script src="../codemirror-javascript-mode.js"></script>
        <title>MakerLand Help</title>
    </head>
    <body style='padding-top: 50px;'>

        <nav class="navbar navbar-inverse navbar-fixed-top">
          <div class="container">
            <div class="navbar-header">
              <a class="navbar-brand" href="index.html">MakerLand Help</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li><a href="getting-started.html">Getting Started</a></li>
                <li><a href="commands.html">Commands</a></li>
                <li><a href="ideas.html">Ideas</a></li>
                <li class="active"><a href="#">Coding</a></li>
                <li><a href="reference.html">Reference</a></li>
                <li><a href="challenges.html">Challenges</a></li>
              </ul>
            </div><!--/.nav-collapse -->
          </div>
        </nav>

        <div class="container">

            <div class="starter-template">
                <h1>Coding</h1>
                <p class="lead">Putting JavaScript into MakerLand</p>
                <p>Table of contents:</p>
                <ul>
                  <li><a href='#behaviors'>Behaviors</a></li>
                  <li><a href='#animations'>Animations</a></li>
                  <li><a href='#abilities'>Abilities</a></li>
                </ul>
            </div>

            <hr>

            <h2><a name='behaviors'></a>Behaviors</h2>

            <h3><a name='what-are-behaviors'></a>What are behaviors?</h3>

            <p>In MakerLand, a "behavior" is a piece of code that can be
                attached to something that lives in the game world, so that
                the thing "behaves" in a specific way, as defined by the
                code.</p>
            <p>For example, if you wanted to make a portal that teleports
                players to a new location in the game world, you would begin
                by placing a landscape item on the map that looks like a
                portal.  At first, it would do nothing when players stepped
                on it; without a behavior that defines what it means for it
                to teleport players, it is just a decoration.  When the
                teleportation behavior is attached to it, it then becomes an
                active portal.</p>
            <p>MakerLand supports behaviors for landscape items, movable
                items, and creatures.</p>

            <h3><a name='attaching-behaviors'></a>Attaching behaviors</h3>

            <p>A single behavior in the database can be attached to many
                objects in the game world.  The process for attaching it to
                any one item is given here.</p>
            <p>This section assumes that you are working in the Sample
                Universe, or a universe that you created by extending the
                Sample Universe.  In particular, we will be attaching the
                "Shows text (like a sign)" behavior to a landscape item, so
                your universe must have that behavior.  Also, you should go
                stand near a landscape item, such as one of the tree in the
                Sample Universe, to use in the following steps.</p>
            <ol>
                <li>Move your avatar near the landscape item to which you
                    wish to attach the behavior.</li>
                <li>Click the World command button, then the "Edit landscape
                    items on map" button.</li>
                <li>Click the landscape item you wish to edit.
                    (If there are many items on top of one another,
                    it will list them all and ask you to choose the one you
                    intended to click.)</li>
                <li>Click the "Edit behaviors" button for that item.</li>
                <li>Browse the list of behaviors until you
                    find "Shows text (like a sign)".  Click its Attach
                    button and it will appear on the list of attached
                    behaviors, at the top.</li>
                <li>Click the Edit button on the newly-attached behavior.
                    It shows you that it has exactly one parameter, "text."
                    It also explains to you what that parameter means.  Go
                    ahead and fill in some simple text, such as "Hello" and
                    then save.</li>
            </ol>
            <p>The behavior has been attached to the landscape item.  Take a
                step away from the landscape item (if you're standing on top
                of it) and then back onto it.  The behavior should activate,
                and you should be able to see the text, as if the item were
                a sign.</li>
            <p>To un-attach a behavior, follow the same sequence of steps as
                above, but instead of clicking Attach, click Remove.</p>

            <h3><a name='many-opportunities'></a>Many opportunities</h3>

            <p>Although the example above just shows you how to make a
                landscape item show text like a sign, there are many more
                things you can do with behaviors.  The Sample Universe comes
                with built-in behaviors that do all of the following.</p>
            <ul>
                <li>Shows text (as introduced above)</li>
                <li>Teleports a player (which is how the portal transports a
                    player from the introductory hallway to the island)</li>
                <li>Spawns a creature (which makes landscape items
                    periodically spawn copies of a creature)</li>
                <li>Wanders near spawn point (which you attach to a
                    creature to make it wander near its spawn point)</li>
                <li>Gives a player a new command (which you use to grant
                    brand new players access to all the basic commands, and
                    new makers all the maker commands, as described below)
                    </li>
            </ul>
            <p>In addition to these examples, you can create new behaviors,
                as discussed in the next section.  But even without just the
                behaviors in the Sample Universe, you can already create
                some very interesting things.  If you're in the Sample
                Universe, the Getting Started page suggests several projects
                you can now accomplish, using what you know about behaviors.
                </p>

            <h3><a name='writing-behaviors'></a>Writing behaviors</h3>

            <div class='row'>
              <div class='col-md-6'>
                <p>If you are a maker looking to create a behavior, the
                following examples can give you some idea of how to do so.
                They begin with very trivial behaviors that are mostly
                useless, except that they function well as small examples to
                get you started.  Building on those small examples, we
                create larger and larger examples, until we've built the
                teleportation behavior described earlier on this page.</p>
              </div>
              <div class='col-md-6'>
                <div class="alert alert-danger" role="alert"><b>Warning!</b>
                This section assumes that you know how to program in
                JavaScript.  If you do not, you will need to learn to code
                in that language before you will be able
                to understand and/or complete this tutorial.</div>
              </div>
            </div>

            <h4>When does behavior code get run?</h4>
            <p>Behavior code gets run whenever the object to which it is
            attached gets loaded.  Examples:</p>
            <ul>
                <li>When you create a movable item in your inventory, any
                    behaviors attached to that item will have their code
                    run.</li>
                <li>When a player enters an area for the first time since
                    your game has loaded, all landscape items in that area
                    are created and their behavior code is run.</li>
                <li>If such landscape items have a behavior that spawns a
                    creature, that creature will therefore also be created,
                    and so any behaviors attached to it will be run.</li>
                <li>If players stay away from an area for a long time, its
                    contents will be unloaded to save memory.  When they
                    come back later, it will be reloaded, and the events
                    above will happen again.</li>
            </ul>
            <p>So when you're writing behavior code, think of it as code
            that <i>sets up</i> the object to which it's attached.  Assume
            the object was just loaded, and you need to add some new
            functionality to it.</p>

            <h4>What does behavior code look like?</h4>
            <p>You can see the code by browsing the Behaviors table in the
            game database, clicking "edit" on an entry, and then clicking
            "Edit implementation."  Let's look at the shortest example in
            the Sample Universe, the behavior that gives a player a new
            command.  Its code is the following.</p>
            <textarea class='code'>
// Listen for when a player enters this landscape item:
this.on( 'entered', function ( player ) {
    // Try to grant them the new command.  The following function will return true if the
    // player got the command, or false if they already had it.
    if ( player.grantCommand( command ) ) {
        // They just got the command, so we show them some text, with an OK button after it.
        player.showOK( "<h1>You learned a new command!</h1>"
                     + "<p>You can now use the \"" + command + "\" command.  "
                     + "When you click OK below, you will see it on your commands list.</p>"
                     + "<p>" + message + "</p>" );
        // We also play the "new command access" sound effect from the sounds table.
        playSound( 'new command access', player );
    }
} );</textarea>
            <p>Wow, there's a lot to notice there!  Let's consider each
            of the many things we can learn from this code.  (Keep in
            mind that I assume you already speak some JavaScript.)</p>
            <ul>
                <li>Behavior code in the Sample Universe is carefully
                commented to explain what's going on.</li>
                <li>The <code>this</code> keyword is defined in all
                behaviors.  It refers to the object to which the
                behavior is attached.  The behavior shown above is
                designed to be attached to a landscape item, so
                <code>this</code> will be that landscape item.</li>
                <li>Various objects have useful methods that it helps to
                know.  For instance, the <code>on</code> method is
                called in the landscape item, the
                <code>grantCommand</code> and <code>showOK</code>
                methods are called in a player, and the global
                <code>playSound</code> method is used.  There is reference
                documentation for all such methods, discussed below.</li>
                <li>This function works by installing an <i>event
                handler.</i>  The first line of code effectively says,
                "upon a player's entering this landscape item, do the
                following..."  Event handlers are very common in all
                kinds of coding, especially on the web, and we will use
                them a lot in MakerLand behaviors.</li>
            </ul>

            <h4>What kinds of behaviors can I write?</h4>
            <p>TONS!  Here is a sample list, in an order that makes sense to
                try to read through and learn from, one at a time.  Those
                marked "reference" are links to the reference page, which
                gives full source code you can re-use immediately, with full
                explanations of what each of its parts does.  Those marked
                "idea" are links to the ideas page, which gives some clues
                as to how to build the behavior, but leaves the coding to
                you, as a learning exercise.</p>
            <ul>
                <li><a href='ideas.html#wanders-randomly'>Wanders
                    randomly</a> (idea)</li>
                <li><a href='reference.html#whispers-secret'>Whispers a
                    secret</a> (reference)</li>
                <li><a
                    href='reference.html#occasionally speaks'>Occasionally
                    speaks</a> (reference)</li>
                <li><a href='ideas.html#is-readable'>Is readable</a>
                    (idea)</li>
                <li><a href='reference.html#gives-item'>Gives an item</a>
                    (reference)</li>
                <li><a href='ideas.html#more-gives-item'>Extending the
                    "gives an item" behavior</a> (idea)</li>
                <li><a href='reference.html#is-drinkable'>Is drinkable</a>
                    (reference)</li>
                <li><a href='reference.html#heal-drink'>Heals/harms when
                    drunk</a> (reference)</li>
                <li><a href='ideas.html#stat-drink'>Gives a stat bonus when
                    drunk</a> (idea)</li>
                <li><a href='ideas.html#status-drink'>Gives a status
                    condition when drunk</a> (idea)</li>
                <li><a href='reference.html#equipment-bonus'>Gives a stat
                    bonus when equipped</a> (reference)</li>
                <li><a href='ideas.html#spawns-with-item'>Spawns holding an
                    item</a> (idea)</li>
                <li><a href='ideas.html#spawns-with-item-sometimes'>Spawns
                    holding an item sometimes</a> (idea)</li>
                <li><a href='reference.html#equips-item'>Equips an item it's
                    carrying</a> (reference)</li>
                <li><a href='reference.html#heal-harm-touch'>Heals/harms
                    creatures touching it</a> (reference)</li>
                <li><a href='reference.html#aggression'>Aggression (makes a
                    creature attack things nearby)</a> (reference)</li>
                <li><a href='ideas.html#chases-enemies'>Chases enemies</a>
                    (idea)</li>
                <li><a href='ideas.html#flees-enemies'>Flees enemies</a>
                    (idea)</li>
                <li><a href='reference.html#refills-with-items'>Refills with
                    items from a list</a> (reference)</li>
                <li><a href='reference.html#makes-a-door'>Makes the cell
                    beneath it a door</a> (reference)</li>
                <li><a href='reference.html#makes-a-lock'>Makes a door
                    lockable</a> (reference)</li>
                <li><a href='reference.html#makes-a-key'>Makes an item a
                    door key</a> (reference)</li>
                <li><a href='ideas.html#trades-items'>Trades items with the
                    player</a> (idea)</li>
                <li><a href='ideas.html#walks-a-path'>Walks a set path</a>
                    (idea)</li>
                <li><a href='reference.html#prevent-get'>Can be picked up
                    only by certain people</a> (reference)</li>
                <li><a href='ideas.html#lucky-item'>An item that is lucky to
                    carry</a> (idea)</li>
                <li><a href='reference.html#stat-trainer'>Trains players in
                    a stat</a> (reference)</li>
            </ul>
            <p>Behaviors you write can also trigger animations, but that is
                discussed in the following section.</p>

            <hr>

            <h2><a name='animations'></a>Animations</h2>

            <h3>What are animations?</h3>
            <div class='row'>
              <div class='col-md-6'>
                <p>An animation is a routine that is run in the player's
                browser (not on the game server) for a certain duration
                (usually just a second or two) and that is allowed to draw
                whatever it likes on the game map.  Animations are always
                drawn <i>on top of</i> all the other elements of the game
                map.  Animations know how long they have been running, and
                can use that time measurement to evolve what's being drawn,
                hence the name "animation."</p>
              </div>
              <div class='col-md-6'>
                <div class="alert alert-danger" role="alert"><b>Warning!</b>
                This section assumes that you know how to program in
                JavaScript.  If you do not, you will need to learn to code
                in that language before you will be able
                to understand and/or complete this tutorial.</div>
              </div>
            </div>

            <h3>When does animation code get run?</h3>
            <p>The game map is redrawn many times per second, in order to
                allow for fluid motion and animation; thus animation
                routines are also run many times per second until their
                duration expires.  Animations are run after all other
                drawing of the game map has completed, so that anything the
                animation draws will be overlaid on top of the existing game
                map.</p>
            <p>An animation starts when some code on the game server calls
                the <code>showAnimation()</code> function,
                which passes an animation object to the browsers of all
                players who are close enough to see the animation in
                question.  Two things may trigger a call to
                <code>showAnimation()</code>.</p>
            <ol>
                <li><a href='#writing-behaviors'>Behavior code
                    that you write</a> can call
                    <code>showAnimation()</code>.</li>
                <li>The game server itself has some places in which calls to
                    <code>showAnimation()</code> are built-in.  I list those
                    cases later on this page.</li>
            </ol>
            <p>In your behavior code, if you call
                <code>showAnimation()</code>, you can provide a duration of
                zero, which will run the animation indefinitely.  In that
                case, you should store the return value from that call, and
                later pass it to <code>stopAnimation()</code>, when you want
                to cancel the animation.</p>

            <h3>Who creates animations?</h3>
            <p>Any maker can create them.  Here's how to create a very
                simple animation.  In fact, it's so simple that it doesn't
                show anything on screen!  (More useful animations are
                discussed later.)</p>
            <h3>How to define a new animation</h3>
            <ol>
                <li>Click the Database command button.</li>
                <li>Click the Animations database button.</li>
                <li>At the bottom, click the button to add an entry to the
                    table.</li>
                <li>After the confirmation message, find the entry that was
                    added, and click to edit it.</li>
                <li>Change its name to something simple, like "first
                    animation" or "simple test animation."</li>
                <li>Click the button to edit its implementation, which means
                    its code.  Paste in the following code and save.</li>
            </ol>
            <textarea class='code'>
                console.log( t ); // t is a time parameter explained below
            </textarea>
            <p>If this animation were to be triggered by some in-game event,
                and thus run in a player's browser, it would not actually
                draw anything on the player's screen.  It would simply write
                to the browser's JavaScript console the time parameter t,
                several times per second, until the animation completes
                (after one second, the default animation duration).</p>
            <p>Now let's see how to make animations that
                actually draw something on the screen.</p>

            <h3>What functions can my animation code use?</h3>
            <p>This is a pretty comprehensive list, but it could always
                grow in the future.</p>

            <h4>All 2D context members are in scope</h4>
            <p>MakerLand draws the game map using
                <a href='http://www.w3schools.com/html/html5_canvas.asp'
                >the HTML5 Canvas</a>.  The functions that draw on a
                canvas are those that appear as members of the canvas's
                <a href='http://www.w3schools.com/tags/ref_canvas.asp'
                >2D context object</a>.  (If you have never used the
                HTML5 Canvas before, you should at least skim those
                pages!)</p>
            <p>When animation code is run, the game client has already
                created the 2D context object for the canvas on which
                the game map is being drawn.  Not only that, but all the
                members of that context (e.g.,
                <a href='http://www.w3schools.com/tags/canvas_fillstyle.asp'
                >fillStyle</a>,
                <a href='http://www.w3schools.com/tags/canvas_arc.asp'
                >arc</a>, etc., etc.) are already in scope.  That is,
                you do not need to type
                <code>contextObject.arc( ... );</code>.  You can just
                type <code>arc( ... );</code>.  Here is an example
                animation that, for its duration, draws a red rectangle
                over the top left corner of the canvas.</p>
            <textarea class='code'>
                fillStyle = '#ff0000';
                fillRect( 0, 0, 100, 100 );
            </textarea>
            <p>Your animation code is free to modify the context's fill
                style, stroke style, transform, etc.  The previous state of
                the context is saved before your animation code is run, and
                will be restored thereafter.  Do NOT, however, modify
                the actual functions themselves!  (E.g., do not write
                <code>fillRect = "HAHAHA";</code>.)  That could break
                the game client until the player is forced to reload
                the page.</p>

            <h4>Some handy global objects</h4>
            <p>Your code may also access a few handy global objects,
                most notably <code>gameview</code>, which is the canvas
                itself.  This allows you to, for example, extend the
                rectangle from the previous example to cover the entire
                game map.  If the rectangle were translucent, it could
                be a "got hit" animation.  (The entire view goes
                slightly red for one second.)</p>
            <textarea class='code'>
                fillStyle = '#ff0000';
                globalAlpha = 0.7;
                fillRect( 0, 0, gameview.width, gameview.height );
            </textarea>
            <p>(Technically, this couldn't be a got-hit animation,
                because animations are shown to everyone who can see
                the location at which they take place, rather than
                individual players.  But let's stick with this
                oversimplified example for now, to learn things one
                small piece at a time.)
            <p>Other useful data to which you have access:</p>
            <ul>
                <li><code>currentStatus.name</code> - a string
                    containing the name of the player</li>
                <li><code>currentStatus.isMaker</code> - if true, the
                    player is a maker</li>
            </ul>

            <h4>All global JavaScript functions</h4>
            <p>Of course, all functions defined globally in the browser
                are also available to your animation code.  This can be
                dangerous, in that you could write code that navigated
                the user to a new page.  Don't do that.</p>
            <p>But some things, such as <a
                href='http://www.w3schools.com/jsref/jsref_obj_math.asp'
                >the <code>Math</code> object and its members</a>, can
                be very helpful.  The following example uses random
                numbers in the range 0.0 to 1.0 to make the red overlay
                from the previous example flicker.</p>
            <textarea class='code'>
                fillStyle = '#ff0000';
                globalAlpha = Math.random();
                fillRect( 0, 0, gameview.width, gameview.height );
            </textarea>

            <h4>Data in the parameters object</h4>
            <p>As described earlier on this page, animations are
                triggered when the <code>showAnimation()</code> function
                is called on the server side.  Its third parameter is an
                optional object of parameters to be passed to the
                animation code.  Any members of that object are
                automatically in scope for the animation code.  (They
                have been passed from server to client, so only
                JSONable data is acceptable.)</p>
            <p>Imagine that the flickering red overlay from the previous
                example works well as a got-hit animation, and now you
                want to make a pleasantly yellow version of it to use
                as a got-magically-healed animation.  Rather than
                create a whole new animation, you might just respect a
                "color" parameter, if the call to
                <code>showAnimation()</code> provides one.</p>
            <p>The call on the server side would then look like
                this, assuming your animation is called "flicker":</p>
            <textarea class='code'>
                // to provide no color parameter:
                showAnimation( location, 'flicker' );
                // (location is where in the game world the animation is
                // taking place, so only those nearby will see it)
                // to provide a color parameter, say, yellow:
                showAnimation( location, 'flicker', { color : '#ff00ff' } );
            </textarea>
            <p>In the animation code, we check to see if the color
                parameter was provided, as follows.</p>
            <textarea class='code'>
                if ( typeof color == 'undefined' )
                    fillStyle = '#ff0000';
                else
                    fillStyle = color;
                globalAlpha = Math.random();
                fillRect( 0, 0, gameview.width, gameview.height );
            </textarea>
            <p>You could use this to show a got-hit animation for just
                one player.  The <code>showAnimation()</code> call could
                provide as parameter the name of the player who got hit;
                the animation could only show itself if
                <code>currentStatus.name == whoGotHit</code>.</p>

            <h4>Game-specific global functions</h4>
            <p>The game also provides animations with some useful
                functions for dealing with positions on the map and on
                the screen.</p>
            <ul>
                <li>If <code>loc</code> is a location on the game map
                    (i.e., a <code>[ plane, x, y ]</code> triple,
                    <a href='reference.html#locations'>as documented
                    here</a>) then <code>XY(loc)</code> is its position
                    on the screen.  <code>XY()</code> returns an object
                    with both <code>x</code> and <code>y</code> members,
                    each of which is a number.  There is an example
                    below.</li>
                <li>It is often handier to just get the x coordinate
                    alone or the y coordinate alone, rather than the
                    pair of them as an object.  Thus in place of
                    <code>XY(loc)</code> you can use
                    <code>X(loc)</code> and <code>Y(loc)</code>.
                    Again, see the example below.</li>
                <li>If you have the name of a player (say, passed as a
                    parameter to the animation) and you want to know
                    where the player is on the map, call the
                    <ocde>POS()</code> function on the name.  It
                    converts player name strings to
                    <code>[ plane, x, y ]</code> triples.</li>
                <li>The size of a single cell in pixels (both its width
                    and its height, since it is square) is in the
                    <code>CELL</code> variable.</li>
            </ul>
            <p>We put some of these functions to use in the following
                example.  Imagine that <a href='#writing-behaviors'>you
                have written a behavior</a> that teleports users to a
                certain destination, and when they teleport away, you
                want to show an animation of some kind.  (For
                simplicity, let's just say you want to draw a wavering
                circle around the teleporter as the player goes through
                it.)</p>
            <p>Then your behavior code should make a call like the
                following right when it teleports the player.</p>
            <textarea class='code'>
                // Keep in mind that in behavior code,
                // "this" is the landscape item to which the behavior is attached.
                showAnimation( this.location, 'flickering circle',
                    { location : this.location } );
            </textarea>
            <p>It may seem redundant to pass the location information
                twice.  The first parameter must always be provided, and
                tells the game where the animation is centered, so that
                the game knows which players' browsers need to be told
                to draw the animation.  The second use of
                <code>this.location</code> is only necessary when that
                location is also a parameter that the animation will
                need to know about.</p>
            <p>(Some animations, like the simple examples earlier, fill
                the whole screen and thus don't need to know about any
                particular place on the game map.  Other animations just
                need to know the name of the player around which they're
                centered, and they compute the on-screen position from that
                name, thus moving the animation as the player moves.)</p>
            <p>The animation code corresponding to the call shown above
                looks like this.</p>
            <textarea class='code'>
                strokeStyle = '#0000ff';
                lineWidth = 5;
                arc( X(location), Y(location), // converts location to on-screen coordinates
                     Math.random()*CELL, // randomly shifting radius, up to maximum of cell size
                     0, 2*Math.PI ); // arc goes all the way around the circle, 0 to 2pi
            </textarea>

            <h4>The time variable, <code>t</code></h4>
            <p>Each animation also has access to a variable
                <code>t</code>, which ranges from 0.0 at the start of
                the animation to 1.0 at the end, regardless of the
                animation's duration.  You can use this time variable
                to make your animations evolve in orderly ways.</p>
            <p>For instance, we can modify the previous animation so
                that the circle around the teleporter doesn't just
                change size suddenly and randomly, but shrinks from
                full size to zero over the course of the animation.</p>
            <textarea class='code'>
                strokeStyle = '#0000ff';
                lineWidth = 5;
                arc( X(location), Y(location),
                     (1-t)*CELL, // at t=0 this will be full size; at t=1 it will be zero
                     0, 2*Math.PI );
            </textarea>

            <h4>The <code>memory</code> object</h4>
            <p>Finally, if you have some complex initialization to do at
                the start of your animation, you have access to a
                <code>memory</code> object, which is initially the
                empty object <code>{ }</code>, and which persists
                across all calls to your animation code for the entire
                duration of the animation.  You can store complex data
                in there the first time your animation is called, and
                just retrieve it later.</p>
            <p>As an example, I provide the following particle system
                animation.  Initially, it creates the data for a shower
                of 200 random particles centered at a specific location
                provided as a parameter, <code>center</code>.  Each call
                to the code thereafter re-uses the same initial data, so
                that the animation looks sensible and runs
                efficiently.</p>
            <textarea class='code'>
                if ( !memory.hasOwnProperty( 'particles' ) ) {
                    memory.particles = [ ];
                    for ( var i = 0 ; i < 200 ; i++ ) {
                        var theta = Math.random()*Math.PI;
                        var speed = Math.random()*2*CELL;
                        memory.particles.push( {
                            dx : Math.cos(theta)*speed,
                            dy : -Math.sin(theta)*speed
                        } );
                    }
                }
                strokeStyle = '#0000ff';
                lineWidth = 2;
                globalAlpha = 1 - t;
                for ( var i = 0 ; i < memory.particles.length ; i++ ) {
                    var p = memory.particles[i];
                    var T = Math.sqrt(1 - t);
                    beginPath();
                	arc( X(center)+T*p.dx, Y(center)+T*p.dy+T*T*0.5*CELL, 2, 0, 2*Math.PI );
                	stroke();
                }
            </textarea>
            <p>Note that the first call to your animation routine is
                <i>NOT</i> necessarily when t=0.  For instance, if you
                have an animation that lasts 2 seconds, and it begins,
                but then 1 second later a new player teleports into the
                area, that player will only see the second half of the
                animation.  (That player's browser will receive the
                full animation data, but will be told that the animation
                has already progressed to the 1-second mark.)  Thus the
                <code>t</code> values given to each call of the
                animation function will begin at 0.5, for that player
                only.</p>

            <h3>When does the game itself call
                <code>showAnimation()</code>?</h3>
            <p>The game server itself will call <code>showAnimation()</code>
                at the following times, and with the following
                parameters.  (On top of these, you may call that function
                in any behavior you write, but these are built in.)</p>
            <ul>
                <li>When a player logs in<br>
                    Animation name : "login"<br>
                    Parameter: "player" is the player object that just
                    logged in.  The player may not yet have teleported to an
                    actual position on the game map, but that will happen
                    over the course of the next few instants, depending on
                    network traffic.</li>
                <li>When a player logs out<br>
                    Animation name: "logout"<br>
                    Parameters: "player" is the player object that is
                    logging out or disconnecting, and "position" is the
                    position they had occupied until just an instant before
                    the animation gets run</li>
                <li>When a player speaks<br>
                    Animation name: "speak"<br>
                    Parameters: "text" is the text spoken, and "speaker" is
                    the name of the player who spoke<br>
                    See below for an example implementation of an animation
                    that reacts to this event by showing speech
                    bubbles.</li>
                <li>When a maker edits cells on the game map<br>
                    Animation name: "map edit"<br>
                    Parameters: "player" is the player object that edited
                    the map, and "location" is the
                    <code>[ plane, x, y ]</code> triple for the center of
                    the edited region.</li>
                <li>When a maker copies/pastes blocks on the game map<br>
                    Animation name: "highlight region"<br>
                    Parameters: "corner1" is the position of the top left
                    corner cell of the block, and "corner2" is the bottom
                    right</li>
                <li>When a player teleports away from a location<br>
                    Animation name: "teleport out"<br>
                    Parameters: "center" is the location away from which the
                    player teleported</li>
                <li>When a player teleports into a location<br>
                    Animation name: "teleport in"<br>
                    Parameters: "center" is the location into which the
                    player teleported</li>
                <li>When a player is harmed or healed (not including the
                    slow trickle of health regain players experience
                    constantly)<br>
                    Animation name: "sparkle" (because that is one
                    reasonable way to show this--with a red/white
                    sparkle/shimmer animation)<br>
                    Parameters: "target" is the name of the player (or the
                    ID of the creature, if it is not a player) and "color"
                    is the desired color of the sparkle (which will be red
                    for harm and yellow for heal)</li>
                <li>Under the same conditions as the previous, the following
                    animation is also shown; universes need not implement it
                    if they do not wish health bars to appear over the heads
                    of creatures in the game.<br>
                    Animation name: "health bar" (because the intent is that
                    you can use this to draw a health meter over the head
                    of the creature when needed)<br>
                    Parameters: "target" which is as in the previous item,
                    "previous," "current," and "maximum" which are numbers
                    of hit points; previous is what the creature had before
                    the most recent harm/heal, current is what it just
                    changed to moments ago, and maximum is just that.</li>
                <li>When a creature dies<br>
                    Animation name: "death"<br>
                    Parameters: "position", the location where the creature
                    was immediately before it died (and thus disappeared
                    from the game map)</li>
                <li>When one creature hits another in combat<br>
                    Animation name: "hit"<br>
                    Parameters: "agent," a string containing the player name
                    (or creature ID) of the hitter, and "target," a string
                    containing the player name (or creature ID) of the one
                    who got hit, and "strength," a number proportional to
                    the damage done</li>
                <li>When one creature misses another in combat<br>
                    Animation name: "miss"<br>
                    Parameters: same as for "hit," except for "strength"
                    </li>
            </ul>

            <h3>Ready-to-use, nontrivial examples</h3>
            <p>The Sample Universe implements 7 of the above animations,
            and you can freely inspect/change/copy the code for each of them
            as an admin in the Sample Universe.  The 7 in question are
            show text, speak, map edit, highlight region, hit, miss, and
            death.</p>

            <h3>Exercises</h3>
            <p><a href='ideas.html#animations'>Check out the ideas here for
            a first animation you can create</a>, in a step-by-step way, to
            add a toy item to your game.</p>
            <p>Then add to the Sample Universe animations for each of the
            built-in animation types for which the Sample Universe does not
            provide animations.  Those are login, logout, teleport in,
            teleport out, and death.</p>
            <p>Then consider each of the behaviors you've added to the game.
            Would any of them be more aesthetically pleasing to the player
            if they came with an animation?  If so, add an animation to the
            database for the behavior, and trigger it from the behavior code
            with <code>showAnimation()</code>.</p>

            <hr>

            <h2><a name='abilities'></a>Abilities</h2>

            <h3><a name='what-are-abilities'></a>What are abilities?</h3>

            <p>Players have many commands they can use, all of which appear
                on the right hand side of the screen as buttons (e.g.,
                Quit, Players, Settings, Talk, etc.).  An ability is a
                special type of command, one that is associated with a
                skill that can be trained.</p>
            <p>Typically players earn them in some way, out in the game
                world, and then train them over time, by spending experience
                points.  There can be many kinds of abilities, but typical
                kinds include combat, healing, navigating, and so on.</p>
            <p>Here are some examples.  A player may find an army camp and
                find there a trainer that teaches him a parrying ability
                that increases his defensive skills when used.  A player
                may visit a local witch doctor and learn from her abilities
                related to healing allies and harming enemies with magic.
                After we see how to make abilities, we'll see a list of many
                such ideas, together with tips on how to code them.</p>

            <h3><a name='giving-abilities'></a>Giving players abilities</h3>

            <p>To create a new ability that players can earn, follow a
                two-step process.</p>
            <ol>
                <li>Create the ability in the database.</li>
                <ul>
                    <li>Click the Database command, then the Abilities
                        table button, then the "Add entry" button at the
                        bottom.</li>
                    <li>After the confirmation message, find the new entry
                        and click its "edit" button.</li>
                    <li>Set the basic information about the ability.  Here
                        is what each piece of information means.</li>
                    <ul>
                        <li>The Name is the text that will appear on the
                            button in the player's command pane.  It should
                            be short, so it fits on the button.</li>
                        <li>The Icon will appear on the button to the left
                            of the text, as in all the other command
                            buttons.  It should be of size 32x32.</li>
                        <li>The Category is the heading that will appear
                            above the ability.  For instance, Basic Commands
                            and Maker Commands are two categories.  Your
                            universe might have Magic Commands, Soldier
                            Commands, and so on.</li>
                        <li>The Short Info is the text that will appear to
                            the right of the button.  It can be a bit longer
                            than the text on the button, but just 5-10
                            words, so that it does not get too tall and
                            space out the command buttons too much.</li>
                        <li>The Help Text will show up if the player hovers
                            their mouse pointer over the button.  This can
                            be a few sentences long.</li>
                    </ul>
                    <li>Then you must edit the implementation of the
                        ability, but we have not yet covered how to do so.
                        For now, you can ignore this, and the ability will
                        do nothing when used.  We'll cover how to code an
                        ability further below.</li>
                </ul>
                <li>Create a landscape item in the game that players can
                    visit to gain the new ability, as a command.</li>
                <ul>
                    <li>The Sample Universe comes with a behavior called
                        "Gives a player a new command," which can be
                        attached to landscape items so that when players
                        step on them, they gain a new command.  You may have
                        used this when creating the New Player and New Maker
                        tutorials, if you have followed
                        <a href='getting-started.html'>the Getting Started
                        tutorial</a>.</li>
                    <li>You can re-use that same thing here
                        to make certain locations in your game (such as a
                        wizard's classroom or a general's office) be a place
                        where a player learns a new ability.  The ability
                        name is the command that the behavior should
                        grant to players.</li>
                    <li>For simple abilities, you may want to place the
                        landscape item that grants them somewhere easy to
                        access, so that players can get the ability easily.
                        For powerful abilities, you may want to place the
                        landscape item at the end of a difficult quest, or
                        an area filled with tough enemies, so that players
                        need to work hard for the reward.</li>
                </ul>
            </ol>

            <h3><a name='writing-abilities'></a>Implementing abilities</h3>

            <p>An ability's code is run with the player executing the
                ability as the <code>this</code> object.  So you could make
                your very first ability just give the player a message,
                like so:</p>
            <textarea class='code'>
this.showOK( "This ability just shows a message; that's all." );</textarea>

            <p>Feel free to try that out right now.  Create such an ability,
                create a landscape item that grants it to you, get the
                ability yourself as a maker, and then run it.  You should
                see that message in your command pane.</p>
            <p>You'll probably want to make sure that an ability is only
                executed every so often, so that a player can't just spam
                an ability and be all-powerful.  (Some games call this a
                "cooldown" period.)  The game facilitates this by providing
                you two functions in the player object.</p>
            <p>Call <code>this.checkAbility('ability name here')</code>
                function to see if an ability is ready to use.  This will
                return true if it is, and false otherwise.  Furthermore, if
                the check fails, that method will also show the player a
                status message saying that they can't use the ability again
                yet.  (So you don't have to bother showing any message in
                your code.)</p>
            <p>Call
                <code>this.startAbilityCooldown('ability name',time)</code>
                when your ability code has been run, to start the cooldown
                time.  The <code>time</code> parameter is in seconds.  This
                will also automatically notify the player when the cooldown
                period has ended, so that you don't have to.  (It shows in
                the player's status messages.)</p>
            <p>Therefore the code for many abilities will take the following
                form:</p>
            <textarea class='code'>
// ensure the ability is not on cooldown
if ( !this.checkAbility( 'example ability' ) ) return;
// do the actual ability, which is still just this one line for now
this.showOK( "This ability just shows a message; that's all." );
// start the ability on cooldown
this.startAbilityCooldown( 'example ability', 5 );</textarea>

            <p>Now let's see how to make a non-example ability.  Let's just
                make it damage the user's current primary enemy immediately.
                We'll use the function built into living things
                <code>living.changeHealth( amount, whoDidIt )</code>,
                in which <code>amount</code> can be positive (heal) or
                negative (harm), and in which <code>whoDidIt</code> is the
                player or creature who performed the heal/harm.  We also
                use <code>living.reachableEnemies()</code> which returns an
                array containing exactly what you'd expect.</p>
            <textarea class='code'>
// ensure the ability is not on cooldown
if ( !this.checkAbility( 'whack' ) ) return;
// find out if we have a primary enemy to whack
var targets = this.reachableEnemies();
if ( targets.length == 0 ) {
    // no enemy nearby, so tell the player that as a 5-second status message
    this.addStatusCondition( 'No enemy nearby!', 5 );
    // then be done
    return;
}
// whack the primary enemy
targets[0].changeHealth( -20, this );
// start the ability on cooldown
this.startAbilityCooldown( 'whack', 10 );</textarea>

            <p>You would not, however, expect that the "whack" ability
                should always take exactly 20 hit points.  You'd expect to
                be able to train it, and improve its power, or decrease its
                cooldown.  In fact, each ability a player gains
                automatically adds itself to that player's list of stats,
                and has value 1.  You should provide a location in the game
                where players can train that stat.  (Recall the
                <a href='reference.html#stat-trainer'>free sample code</a>
                that shows you how to create such a training place.)</p>
            <p>We should therefore write code that takes the stat value into
                account, using <code>player.getStat( 'whack' )</code>.  We
                could do so by changing one line of code in the above
                example, as follows.</p>
            <textarea class='code'>
// whack the primary enemy
targets[0].changeHealth( -20, this );</textarea>

            <p>But that's got a serious problem.  First of all, it means
                that a player who just learned the "whack" ability will only
                do 1 damage with it at first, which is nearly useless.
                Second, if you let players train stats higher and higher
                indefinitely, they could train the "whack" ability to do
                an awful lot of damage.  You might want a maximum on it.</p>
            <p>To solve these problems, abilities provide a global function
                <code>asymptotic(low,high,mid,stat)</code> you can use to
                compute the impact of an ability's stat value.  When you
                call <code>asymptotic</code>, provide these values:</p>
            <ul>
                <li>For <code>low</code> use the lowest output value
                    possible, for when the stat is near zero.</li>
                <li>For <code>high</code> use the highest output value
                    possible, which will never actually be obtained, but
                    will be asymptotically approached as the stat is
                    increased without limit.</li>
                <li>For <code>mid</code> provide the stat value at which
                    the player should expect to receive output half way
                    between <code>low</code> and <code>high</code>.</li>
                <li>For <code>stat<code>, provide the actual current value
                    of the player's stat.</li>
            </ul>
            <p>For example, let's say we wanted "whack" to do somewhere
                between 10 and 50 damage, and that the half-way point (30)
                should be achieved when the player has trained his/her
                "whack" stat up to level 75.  We could change the line of
                code mentioned above into the following.</p>
            <textarea class='code'>
// what is our current whacking skill level?
var stat = this.getStat( 'whack' );
// how much damage will that let us do?
var damage = asymptotic( 10, 50, 75, stat );
// whack the primary enemy
targets[0].changeHealth( -damage, this );</textarea>

            <p>You might also like to decrease the cooldowin as the player
                trains the stat.  Perhaps it should start with a slow
                cooldown (20 sec) and end up with a fast cooldown (8 sec),
                reaching the midpoint (14 sec) when the stat is at level 50.
                The following code will do that.</p>
            <textarea class='code'>
// how long of a cooldown, given my "whack" stat level computed above?
var cooldown = asymptotic( 20, 8, 50, stat );
// start the ability on cooldown
this.startAbilityCooldown( 'whack', cooldown );</textarea>

            <p>You now know enough to make some pretty cool abilities.  Take
                the pattern introduced above and consider the various things
                you can do using code you learned at the top of this page,
                when learning to code behaviors, or any of the many
                functions documented on <a href='reference.html'>the
                reference page</a>.  There are many ideas of possible
                abilities you could create <a href='ideas.html#abilities'>on
                this page</a>.  But before you do, here are a few final
                tips that fall into the "miscellaneous" category.</p>

            <p><b>Include animations.</b>  The player using the ability will
                want to see visual feedback that the ability happened.  Thus
                you should almost always create an animation to go along
                with each ability you create, and fire it from within your
                ability code, using <code>showAnimation()</code>.  This is
                especially important for abilities that impact other players
                nearby, because they will need to see the animation to know
                what's going on, or that an ability was even used in the
                first place.</p>

            <p><b>Map click mode.</b>  Some abilities may require targeting
                a specific area of the map.  To do so, you will want to
                prompt the player to click somewhere on the map, give them a
                target-shaped mouse cursor, and find out where on the map
                they clicked.  This can all be done with just one function
                in your code.  It is defined in the player object, and is
                summarized by the code below.</p>
            <textarea class='code'>
// recall that "this" is the player executing the ability.
var player = this;
// the following call initiates map click mode.
player.mapClickMode( 'Click on the map where you want to place the bomb.',
    // (or whatever prompt you want them to see)
    function ( x, y ) {
        // this callback function will only be called if the player actually
        // clicks on the map.  the player may instead cancel the action.
        // if this callback is called, then the x and y values will be in
        // map coordinates, and to form an actual [plane,x,y] location from
        // them, you will need to use the player's current plane, which you
        // can extract from this.getPosition().
        // YOU ABSOLUTELY MUST end this function with a call like this,
        // which gives the player back their ordinary user interface:
        player.showCommandUI();
        // (well, okay, instead of that, you could call mapClickMode again,
        // if you wanted to re-enter map click mode, but you have to show
        // *some* UI)
    } );</textarea>

            <a name='stat-competition'></a>
            <p>Finally, it is sometimes sensible to run a test of the user's
                ability level against some stat of an opponent.  For example
                the "whack" ability above should perhaps take into account
                the opponent's dodging ability.  To do so, you can run a
                "stat competition" between two creatures.</p>
            <p>To have a competition between stat S1 in creature C1 against
                stat S2 in creature C2, do the following.  The function
                <code>random.statCompetition()</code> returns true if the
                first player wins the competition or false if the second
                player does.  We might integrate this into the "whack" code
                as follows.</p>
            <textarea class='code'>
// what is our current whacking skill level?
var stat = this.getStat( 'whack' );
// can the enemy dodge our whack?
if ( random.statCompetition( targets[0], 'dodging ability',
                             this,       'whack' ) ) {
    // the enemy won the stat competition, so we show that we missed
    showAnimation( this.getPosition(), 'miss',
        { agent : this, target : targets[0] } );
    playSound( 'miss', this.getPosition() );
    return;
}
// how much damage will that let us do?
var damage = asymptotic( 10, 50, 75, stat );
// whack the primary enemy
targets[0].changeHealth( -damage, this );</textarea>

            <p>Go check out the <a href='ideas.html#abilities'>many ideas
                for making your own abilities</a>, or ignore our ideas
                entirely and get creative on your own!  Your players will
                thank you for it, and love your universe better for its
                depth.</p>

        </div>
    </body>
    <script src='codemirror-for-textareas.js'></script>
</html>
